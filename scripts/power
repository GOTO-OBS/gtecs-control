#!/usr/bin/env python3
"""A script to provide control over the power daemon."""

import json
import os
import sys

from gtecs.common import logging
from gtecs.common.system import execute_long_command
from gtecs.control import daemons
from gtecs.control import params
from gtecs.control.style import errortxt


def query(command, args):
    """Process a query."""
    daemon_id = os.path.basename(__file__)

    # Primary daemon control
    if command == 'start':
        host, port = daemons.get_daemon_host(daemon_id)
        pid = daemons.start_daemon(daemon_id)
        print(f'Daemon {daemon_id} started on {host}:{port} (PID {pid})')

    elif command == 'shutdown':
        host, port = daemons.get_daemon_host(daemon_id)
        daemons.shutdown_daemon(daemon_id)
        print(f'Daemon {daemon_id} shutdown on {host}:{port}')

    elif command == 'restart':
        host, port = daemons.get_daemon_host(daemon_id)
        pid = daemons.restart_daemon(daemon_id)
        print(f'Daemon {daemon_id} restarted on {host}:{port} (PID {pid})')

    elif command == 'kill':
        host, port = daemons.get_daemon_host(daemon_id)
        daemons.shutdown_daemon(daemon_id, kill=True)
        print(f'Daemon {daemon_id} killed on {host}:{port}')

    elif command in ['check', 'ping']:
        host, port = daemons.get_daemon_host(daemon_id)
        pid = daemons.check_daemon(daemon_id)
        print(f'Daemon {daemon_id} is running on {host}:{port} (PID {pid})')

    elif command in ['info', 'status']:
        if len(args) == 0:
            info_type = 'simple'
            force = False
        elif len(args) == 1 and args[0] in ['f', 'F', '-f', '-F', '--force-update']:
            info_type = 'simple'
            force = True
        elif len(args) == 1 and args[0] in ['v', 'V', '-v', '-V', '--verbose']:
            info_type = 'verbose'
            force = False
        elif len(args) == 1 and args[0] in ['r', 'R', '-r', '-R', '--raw']:
            info_type = 'raw'
            force = False
        elif (len(args) == 2 and
              ((args[0] in ['v', 'V', '-v', '-V', '--verbose'] and
                args[1] in ['f', 'F', '-f', '-F', '--force-update']) or
               (args[1] in ['v', 'V', '-v', '-V', '--verbose'] and
                args[0] in ['f', 'F', '-f', '-F', '--force-update']))):
            info_type = 'verbose'
            force = True
        elif (len(args) == 2 and
              ((args[0] in ['r', 'R', '-r', '-R', '--raw'] and
                args[1] in ['f', 'F', '-f', '-F', '--force-update']) or
               (args[1] in ['r', 'R', '-r', '-R', '--raw'] and
                args[0] in ['f', 'F', '-f', '-F', '--force-update']))):
            info_type = 'raw'
            force = True
        else:
            raise ValueError('Invalid arguments')
        daemons.check_daemon(daemon_id)
        with daemons.daemon_proxy(daemon_id) as daemon:
            info = daemon.get_info(force)
        if not info:
            raise ValueError('No info returned, check daemon')
        elif info_type == 'simple':
            print_info_s(info)
        elif info_type == 'verbose':
            print_info(info)
        elif info_type == 'raw':
            print(json.dumps(info, indent=2, default=repr))

    elif command in ['log', 'tail']:
        if 'stdout' in args:
            log_file = f'{daemon_id}-stdout.log'
            args.remove('stdout')
        else:
            log_file = f'{daemon_id}.log'
        log_path = logging.get_log_path() / log_file
        tail_command = 'tail {} {}'.format(log_path, ' '.join(args))
        execute_long_command(tail_command)

    # Daemon functions
    elif command in ['on', 'off', 'reboot']:
        if len(args) == 1:
            unit = None
            outlets = args[0].split(',')
        elif len(args) == 2:
            unit = args[0]
            outlets = args[1].split(',')
        else:
            raise ValueError('Invalid arguments')
        daemons.check_daemon(daemon_id)
        with daemons.daemon_proxy(daemon_id) as daemon:
            if command == 'on':
                daemon.on(outlets, unit)
                print('Outlets turning on')
            elif command == 'off':
                daemon.off(outlets, unit)
                print('Outlets turning off')
            elif command == 'reboot':
                daemon.reboot(outlets, unit)
                print('Outlets rebooting')

    elif command in ['list', 'ls', 'outlets']:
        print_outlets(params.POWER_UNITS, params.POWER_GROUPS)

    # Unrecognized function
    else:
        raise ValueError('Unrecognized command "{}"'.format(command))


def print_info(info):
    """Print the full info dict."""
    print('####### POWER INFO ########')
    for unit in params.POWER_UNITS:
        unit_class = params.POWER_UNITS[unit]['CLASS']
        ip = params.POWER_UNITS[unit]['IP']
        if 'PORT' in params.POWER_UNITS[unit]:
            port = params.POWER_UNITS[unit]['PORT']
            port_str = ':{}'.format(port)
        print('UNIT {} ({}{})'.format(unit, ip, port_str))
        status = info['status_' + unit]
        if 'UPS' in unit_class:
            print('Status: {}'.format(status['status']))
            print('Current load:       {}%'.format(status['load']))
            print('Percent remaining:  {}%'.format(status['percent']))
            print('Time remaining:     {}s'.format(status['time']))
        if 'ATS' in unit_class:
            print('Status: {}'.format(status['status']))
            print('Current source:     {}'.format(status['source']))
            print('Source A status:    {}'.format(status['status_A']))
            print('Source B status:    {}'.format(status['status_B']))
        if 'NAMES' in params.POWER_UNITS[unit]:
            names = params.POWER_UNITS[unit]['NAMES']
            for outlet in names:
                outlet_name = '({}):'.format(outlet)
                outlet_no = names.index(outlet) + 1
                outlet_status = status[outlet].capitalize()
                print('Outlet {: <2} {: <15} {}'.format(outlet_no, outlet_name, outlet_status))
        print('~~~~~~~')

    print('Uptime: {:.1f}s'.format(info['uptime']))
    print('Timestamp: {}'.format(info['timestamp']))
    print('###########################')


def print_info_s(info):
    """Print the info dict in a compact way."""
    for unit in params.POWER_UNITS:
        unit_class = params.POWER_UNITS[unit]['CLASS']
        ip = params.POWER_UNITS[unit]['IP']
        if 'PORT' in params.POWER_UNITS[unit]:
            port = params.POWER_UNITS[unit]['PORT']
            port_str = ':{}'.format(port)
        status = info['status_' + unit]
        if 'status' in status:
            unit_status = status['status']
            print('{} ({}{})       [{}]'.format(unit, ip, port_str, unit_status))
        else:
            print('{} ({}{})'.format(unit, ip, port_str))
        if 'UPS' in unit_class:
            print('   Load: {: >5}%'.format(status['load']))
            print('   Remaining: {}% ({}s)'.format(status['percent'], status['time']))
        if 'ATS' in unit_class:
            if status['source'] == 'A':
                source_status = status['status_A']
            else:
                source_status = status['status_B']
            print('   Current source: {} ({})'.format(status['source'], source_status))
        if 'NAMES' in params.POWER_UNITS[unit]:
            names = params.POWER_UNITS[unit]['NAMES']
            for outlet in names:
                outlet_name = '({}):'.format(outlet)
                outlet_no = names.index(outlet) + 1
                outlet_status = status[outlet].capitalize()
                if outlet[0] != '_':
                    print('   Outlet {:<2} {: <15} [{}]'.format(outlet_no,
                                                                outlet_name,
                                                                outlet_status))


def print_outlets(unit_dict, group_dict):
    """Print the outlets and groups."""
    print('OUTLETS:')
    for unit in unit_dict:
        string = '   {: >7}:  '.format(unit.upper())
        if 'NAMES' in params.POWER_UNITS[unit]:
            for name in unit_dict[unit]['NAMES']:
                if name[0] != '_':
                    string += '{}, '.format(name)
            print(string[:-2])
        else:
            print(string)

    print('GROUPS:')
    for group in group_dict:
        string = '   {: >7}:  '.format(group)
        for name in group_dict[group]:
            if name[0] != '_':
                string += '{}, '.format(name)
        print(string[:-2])


if __name__ == '__main__':
    try:
        command, *args = sys.argv[1:]
    except ValueError:
        # no command, print help and exit
        command = 'help'

    if command in ['help', '?']:
        print(
            'Usage: power command [options]',
            'Daemon commands:',
            '  start                          start the daemon',
            '  shutdown                       shutdown the daemon',
            '  restart                        restart the daemon',
            '  kill                           kill the daemon',
            '  check/ping                     check the daemon for errors',
            'Power commands:',
            '  on [names]|[unit outlet]       turn on specified outlet(s)',
            '  off [names]|[unit outlet]      turn off specified outlet(s)',
            '  reboot [names]|[unit outlet]   reboot specified outlet(s)',
            '  outlets/list                   list valid outlets and groups',
            '  info/status [-r|-v] [-f]       report current status [raw/verbose/force-update]',
            '  log [stdout]                   print daemon log (tail alias)',
            'Control commands:',
            '  i                              enter interactive mode',
            '  q/exit                         quit interactive mode',
            '  ?/help                         print these instructions',
            sep='\n')
        sys.exit()

    if command == 'i':
        while True:
            try:
                interactive_input = input(f'{os.path.basename(__file__)}> ').split()
            except EOFError:
                print()
                sys.exit()
            if len(interactive_input) > 0:
                command, *args = interactive_input
                if command in ['q', 'exit']:
                    sys.exit()
                if command == 'i':
                    print(errortxt('"ValueError: Already in interactive mode"'))
                    continue
                try:
                    query(command, args)
                except Exception as error:
                    print(errortxt(f'"{type(error).__name__}: {error}"'))

    try:
        query(command, args)
    except Exception as error:
        print(errortxt(f'"{type(error).__name__}: {error}"'))
