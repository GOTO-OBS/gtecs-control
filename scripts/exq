#!/usr/bin/env python

########################################################################
#                                exq.py                                #
#           ~~~~~~~~~~~~~~~~~~~~~~~##~~~~~~~~~~~~~~~~~~~~~~~           #
#           G-TeCS script to provide control over exq_daemon           #
#                    Martin Dyer, Sheffield, 2015-16                   #
#           ~~~~~~~~~~~~~~~~~~~~~~~##~~~~~~~~~~~~~~~~~~~~~~~           #
#                   Based on the SLODAR/pt5m system                    #
########################################################################

### Import ###
# Python modules
from __future__ import absolute_import
from __future__ import print_function
import os, sys
import readline
import time
import Pyro4
from six.moves import input, range
# TeCS modules
from gtecs.tecs_modules import misc
from gtecs.tecs_modules import params
from gtecs.tecs_modules import daemons

########################################################################
# Interactive functions

def interactive():
    while True:
        i_in = input('{}> '.format(daemon_ID)).split()
        if len(i_in) > 0:
            command, *args = i_in
            if command == 'q' or command == 'exit':
                return
            else:
                query(command, args)

def query(command, args):
    #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # Primary control functions
    if command == 'start':
        daemons.start_daemon(daemon_ID)
    elif command == 'shutdown':
        daemons.shutdown_daemon(daemon_ID)
    elif command == 'restart':
        daemons.restart_daemon(daemon_ID)
    elif command == 'kill':
        daemons.kill_daemon(daemon_ID)
    elif command == 'ping':
        daemons.ping_daemon(daemon_ID)
    elif command == 'help' or command == '?':
        print_instructions()
    elif command == 'i':
        print(misc.ERROR('Already in interactive mode'))

    #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # Camera control functions
    elif command == 'info':
        if len(args) == 0:
            info = daemons.daemon_function(daemon_ID, 'get_info')
            if info: print_info_s(info)
        elif len(args) == 1 and args[0] in ['v','V','-v','-V']:
            info = daemons.daemon_function(daemon_ID, 'get_info')
            if info: print_info(info)
        else:
            print(misc.ERROR('Invalid arguments'))

    elif command == 'image':
        if len(args) < 3:
            print(misc.ERROR('Need at least: exptime filter binning'))
        elif misc.is_num(args[0]) and misc.is_num(args[2]):
            # exptime filter binning [object] [imgtype]
            tel_list  = list(params.TEL_DICT)
            exptime   = float(args[0])
            filt      = args[1]
            binning   = int(args[2])
            frametype = 'normal'
            if len(args) == 3:
                target  = 'NA'
                imgtype = 'SCIENCE'
            elif len(args) == 4:
                target  = args[3]
                imgtype = 'SCIENCE'
            elif len(args) == 5:
                target  = args[3]
                imgtype = args[4]
            arg_list = [tel_list, exptime, filt, binning, frametype, target, imgtype]
            c = daemons.daemon_function(daemon_ID, 'add', arg_list)
            if c: print(c)
        elif misc.is_num(args[1]) and misc.is_num(args[3]):
            # tels exptime filter binning [object] [imgtype]
            tel_list  = misc.valid_ints(args[0].split(','),list(params.TEL_DICT))
            exptime   = float(args[1])
            filt      = args[2]
            binning   = int(args[3])
            frametype = 'normal'
            if len(args) == 4:
                target  = 'NA'
                imgtype = 'SCIENCE'
            elif len(args) == 5:
                target  = args[4]
                imgtype = 'SCIENCE'
            elif len(args) == 6:
                target  = args[4]
                imgtype = args[5]
            arg_list = [tel_list, exptime, filt, binning, frametype, target, imgtype]
            if len(tel_list) > 0:
                c = daemons.daemon_function(daemon_ID, 'add', arg_list)
                if c: print(c)
        else:
            print(misc.ERROR('Invalid arguments'))

    elif command == 'multimage' or command == 'multiimage' or command == 'mimage':
        if len(args) < 4:
            print(misc.ERROR('Need at least: Nexp exptime filter binning'))
        elif misc.is_num(args[0]) and misc.is_num(args[1]) and misc.is_num(args[3]):
            # Nexp exptime filter binning [object] [imgtype] [expID]
            Nexp      = int(args[0])
            tel_list  = list(params.TEL_DICT)
            exptime   = float(args[1])
            filt      = args[2]
            binning   = int(args[3])
            frametype = 'normal'
            if len(args) == 4:
                target  = 'NA'
                imgtype = 'SCIENCE'
                expID = None
            elif len(args) == 5:
                target  = args[4]
                imgtype = 'SCIENCE'
                expID = None
            elif len(args) == 6:
                target  = args[4]
                imgtype = args[5]
                expID = None
            elif len(args) == 7:
                target  = args[4]
                imgtype = args[5]
                expID = int(args[6])
            arg_list = [Nexp, tel_list, exptime, filt, binning, frametype, target, imgtype, expID]
            c = daemons.daemon_function(daemon_ID, 'add_multi', arg_list)
            if c: print(c)
        elif misc.is_num(args[0]) and misc.is_num(args[2]) and misc.is_num(args[4]):
            # Nexp tels exptime filter binning [object] [imgtype] [expID]
            Nexp      = int(args[0])
            tel_list  = misc.valid_ints(args[1].split(','),list(params.TEL_DICT))
            exptime   = float(args[2])
            filt      = args[3]
            binning   = int(args[4])
            frametype = 'normal'
            if len(args) == 5:
                target  = 'NA'
                imgtype = 'SCIENCE'
                expID = None
            elif len(args) == 6:
                target  = args[5]
                imgtype = 'SCIENCE'
                expID = None
            elif len(args) == 7:
                target  = args[5]
                imgtype = args[6]
                expID = None
            elif len(args) == 8:
                target  = args[5]
                imgtype = args[6]
                expID = int(args[7])
            arg_list = [Nexp, tel_list, exptime, filt, binning, frametype, target, imgtype, expID]
            if len(tel_list) > 0:
                c = daemons.daemon_function(daemon_ID, 'add_multi', arg_list)
                if c: print(c)
        else:
            print(misc.ERROR('Invalid arguments'))

    elif command == 'dark':
        if len(args) < 2:
            print(misc.ERROR('Need at least: exptime binning'))
        elif misc.is_num(args[0]) and misc.is_num(args[1]) and len(args) == 2:
            # exptime binning
            tel_list  = list(params.TEL_DICT)
            exptime   = float(args[0])
            filt      = params.DARKFILT
            binning   = int(args[1])
            frametype = 'dark'
            target    = 'NA'
            imgtype   = 'DARK'
            arg_list = [tel_list, exptime, filt, binning, frametype, target, imgtype]
            c = daemons.daemon_function(daemon_ID, 'add', arg_list)
            if c: print(c)
        elif misc.is_num(args[1]) and misc.is_num(args[2]) and len(args) == 3:
            # tels exptime binning
            tel_list  = misc.valid_ints(args[0].split(','),list(params.TEL_DICT))
            exptime   = float(args[1])
            filt      = params.DARKFILT
            binning   = int(args[2])
            frametype = 'dark'
            target    = 'NA'
            imgtype   = 'DARK'
            arg_list = [tel_list, exptime, filt, binning, frametype, target, imgtype]
            if len(tel_list) > 0:
                c = daemons.daemon_function(daemon_ID, 'add', arg_list)
                if c: print(c)
        else:
            print(misc.ERROR('Invalid arguments'))

    elif command == 'multdark' or command == 'multidark' or command == 'mdark':
        if len(args) < 3:
            print(misc.ERROR('Need at least: exptime binning'))
        elif misc.is_num(args[1]) and misc.is_num(args[2]) and len(args) in [3,4]:
            # Nexp exptime binning [expID]
            Nexp      = int(args[0])
            tel_list  = list(params.TEL_DICT)
            exptime   = float(args[1])
            filt      = params.DARKFILT
            binning   = int(args[2])
            frametype = 'dark'
            target    = 'NA'
            imgtype   = 'DARK'
            if len(args) == 3:
                expID = None
            else:
                expID = int(args[3])
            arg_list = [Nexp, tel_list, exptime, filt, binning, frametype, target, imgtype, expID]
            c = daemons.daemon_function(daemon_ID, 'add_multi', arg_list)
            if c: print(c)
        elif misc.is_num(args[2]) and misc.is_num(args[3]) and len(args) in [4,5]:
            # Nexp tels exptime binning [expID]
            Nexp      = int(args[0])
            tel_list  = misc.valid_ints(args[1].split(','),list(params.TEL_DICT))
            exptime   = float(args[2])
            filt      = params.DARKFILT
            binning   = int(args[3])
            frametype = 'dark'
            target    = 'NA'
            imgtype   = 'DARK'
            if len(args) == 4:
                expID = None
            else:
                expID = int(args[4])
            arg_list = [Nexp, tel_list, exptime, filt, binning, frametype, target, imgtype, expID]
            if len(tel_list) > 0:
                c = daemons.daemon_function(daemon_ID, 'add_multi', arg_list)
                if c: print(c)
        else:
            print(misc.ERROR('Invalid arguments'))

    elif command == 'bias':
        if len(args) < 1:
            print(misc.ERROR('Need at least: binning'))
        elif misc.is_num(args[0]) and len(args) == 1:
            # binning
            tel_list  = list(params.TEL_DICT)
            exptime   = params.BIASEXP
            filt      = params.DARKFILT
            binning   = int(args[0])
            frametype = 'dark'
            target    = 'NA'
            imgtype   = 'BIAS'
            arg_list = [tel_list, exptime, filt, binning, frametype, target, imgtype]
            c = daemons.daemon_function(daemon_ID, 'add', arg_list)
            if c: print(c)
        elif misc.is_num(args[1]) and len(args) == 2:
            # tels binning
            tel_list  = misc.valid_ints(args[0].split(','),list(params.TEL_DICT))
            exptime   = params.BIASEXP
            filt      = params.DARKFILT
            binning   = int(args[1])
            frametype = 'dark'
            target    = 'NA'
            imgtype   = 'BIAS'
            arg_list = [tel_list, exptime, filt, binning, frametype, target, imgtype]
            if len(tel_list) > 0:
                c = daemons.daemon_function(daemon_ID, 'add', arg_list)
                if c: print(c)
        else:
            print(misc.ERROR('Invalid arguments'))

    elif command == 'multbias' or command == 'multibias' or command == 'mbias':
        if len(args) < 2:
            print(misc.ERROR('Need at least: binning'))
        elif misc.is_num(args[1]) and len(args) in [2,3]:
            # Nexp binning [expID]
            Nexp      = int(args[0])
            tel_list  = list(params.TEL_DICT)
            exptime   = params.BIASEXP
            filt      = params.DARKFILT
            binning   = int(args[1])
            frametype = 'dark'
            target    = 'NA'
            imgtype   = 'BIAS'
            if len(args) == 2:
                expID = None
            else:
                expID = int(args[2])
            arg_list = [Nexp, tel_list, exptime, filt, binning, frametype, target, imgtype, expID]
            c = daemons.daemon_function(daemon_ID, 'add_multi', arg_list)
            if c: print(c)
        elif misc.is_num(args[2]) and len(args) in [3,4]:
            # Nexp tels binning [expID]
            Nexp      = int(args[0])
            tel_list  = misc.valid_ints(args[1].split(','),list(params.TEL_DICT))
            exptime   = params.BIASEXP
            filt      = params.DARKFILT
            binning   = int(args[2])
            frametype = 'dark'
            target    = 'NA'
            imgtype   = 'BIAS'
            if len(args) == 3:
                expID = None
            else:
                expID = int(args[3])
            arg_list = [Nexp, tel_list, exptime, filt, binning, frametype, target, imgtype, expID]
            if len(tel_list) > 0:
                c = daemons.daemon_function(daemon_ID, 'add_multi', arg_list)
                if c: print(c)
        else:
            print(misc.ERROR('Invalid arguments'))

    elif command == 'pause':
        c = daemons.daemon_function(daemon_ID, 'pause')
        if c: print(c)

    elif command == 'resume' or command == 'unpause':
        c = daemons.daemon_function(daemon_ID, 'resume')
        if c: print(c)

    elif command == 'get' or command == 'list' or command == 'ls':
        if len(args) == 0:
            queue_list = daemons.daemon_function(daemon_ID, 'get_simple')
            if queue_list: print(queue_list)
        elif len(args) == 1 and args[0] in ['v','V','-v','-V']:
            queue_list = daemons.daemon_function(daemon_ID, 'get')
            if queue_list: print(queue_list)
        else:
            print(misc.ERROR('Invalid arguments'))

    elif command == 'clear':
        c = daemons.daemon_function(daemon_ID, 'clear')
        if c: print(c)

    #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # Unrecognized function
    else:
        print(misc.ERROR('Unrecognized command "%s"' %command))

########################################################################
# Output formatting functions

def print_info(info):
    print('####### QUEUE INFO #######')
    print('Status: %s' %info['status'])
    print('~~~~~~~')
    print('Current exposure:')
    try:
        print('   %r, %i, %s, %i, %s, %s, %s' \
            %(info['current_tel_list'], info['current_exptime'], info['current_filter'], info['current_binning'], info['current_frametype'], info['current_target'], info['current_imgtype']))
    except:
        print('   None')
    print('Items in queue:     %s' %info['queue_length'])
    print('~~~~~~~')
    print('Uptime: %.1fs' %info['uptime'])
    print('Ping: %.3fs' %info['ping'])
    print('Timestamp: %s' %info['timestamp'])
    print('###########################')

def print_info_s(info):
    print('QUEUE: [%s]' %info['status'])
    print('  Current exposure:', end=' ')
    try:
        print('   %r, %i, %s, %i, %s, %s, %s' \
            %(info['current_tel_list'], info['current_exptime'], info['current_filter'], info['current_binning'], info['current_frametype'], info['current_target'], info['current_imgtype']))
    except:
        print('None')
    print('  Items in queue: %s' %info['queue_length'])

def print_instructions():
    help_str = misc.bold('Usage:') + ' exq [command]' + '\n' +\
    ' ' + misc.undl('Daemon commands') + ':' + '\n' +\
    '  exq ' + misc.bold('start') + '          - start the daemon' + '\n' +\
    '  exq ' + misc.bold('shutdown') + '       - shutdown the daemon' + '\n' +\
    '  exq ' + misc.bold('restart') + '        - restart the daemon' + '\n' +\
    '  exq ' + misc.bold('kill') + '           - kill the daemon (' + misc.rtxt('emergency use') + ')' + '\n' +\
    '  exq ' + misc.bold('ping') + '           - ping the daemon' + '\n' +\
    ' ' + misc.undl('Exposure queue commands') + ':' + '\n' +\
    '  exq ' + misc.bold('image') + ' [tels] exptime filter binning [object] [imgtype]' + '\n' +\
    '  exq ' + misc.bold('multimage') + ' Nexp [tels] exptime filter binning [object] [imgtype]' + '\n' +\
    '  exq ' + misc.bold('dark') + '  [tels] exptime binning' + '\n' +\
    '  exq ' + misc.bold('multdark') + ' Nexp [tels] exptime binning' + '\n' +\
    '  exq ' + misc.bold('bias') + '  [tels] binning' + '\n' +\
    '  exq ' + misc.bold('multbias') + ' Nexp [tels] binning' + '\n' +\
    '  exq ' + misc.bold('pause') + '          - pause taking exposures' + '\n' +\
    '  exq ' + misc.bold('unpause') + '/' + misc.bold('resume') + ' - resumes taking exposures' + '\n' +\
    '  exq ' + misc.bold('list') + ' [v]' + '       - lists the current queue' + '\n' +\
    '  exq ' + misc.bold('clear') + '          - empty the queue' + '\n' +\
    '  exq ' + misc.bold('info') + ' [v]' + '       - report current status' + '\n' +\
    ' ' + misc.undl('Control commands') + ':' + '\n' +\
    '  exq ' + misc.bold('i') + '              - enter interactive mode' + '\n' +\
    '  exq ' + misc.bold('q') + '/' + misc.bold('exit') + '         - quit interactive mode' + '\n' +\
    '  exq ' + misc.bold('?') + '/' + misc.bold('help') + '         - print these instructions'
    print(help_str)

########################################################################

daemon_ID = os.path.basename(__file__)

if len(sys.argv) == 1:
    print_instructions()
else:
    command, *args = sys.argv[1:]
    if command == 'i':
        interactive()
    else:
        query(command, args)
