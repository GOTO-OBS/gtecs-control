#!/usr/bin/env python

########################################################################
#                               lilith.py                              #
#           ~~~~~~~~~~~~~~~~~~~~~~~##~~~~~~~~~~~~~~~~~~~~~~~           #
#       G-TeCS script to provide overall control of the daemons        #
#                     Martin Dyer, Sheffield, 2015                     #
#           ~~~~~~~~~~~~~~~~~~~~~~~##~~~~~~~~~~~~~~~~~~~~~~~           #
#                   Based on the SLODAR/pt5m system                    #
########################################################################

### Import ###
# Python modules
from __future__ import absolute_import
from __future__ import print_function
import os, sys
import readline
import time
import Pyro4
# TeCS modules
from gtecs.tecs_modules import misc
from gtecs.tecs_modules import params

if __name__ == '__main__':
    if sys.argv[1] in ['start', 'shutdown', 'kill', 'ping']:
        if len(sys.argv) > 2:
            daemons = sys.argv[2:]
        else:
            daemons = list(params.DAEMONS) + ['fli'] + ['sitech']

        # handle dependencies
        if 'exq' in daemons:
            # exq needs to start after cam and filt and shutdown first
            if sys.argv[1] == 'start':
                daemons.remove('exq')
                daemons.append('exq')
            elif sys.argv[1] == 'shutdown':
                # move to front
                daemons.remove('exq')
                daemons.insert(0, 'exq')
        if 'fli' in daemons:
            # interfaces need to start before the daemons and shutdown after
            if sys.argv[1] == 'start':
                # move to front
                daemons.remove('fli')
                daemons.insert(0, 'fli')
            elif sys.argv[1] == 'shutdown':
                # move to back
                daemons.remove('fli')
                daemons.append('fli')
        if 'sitech' in daemons:
            # interfaces need to start before the daemons and shutdown after
            if sys.argv[1] == 'start':
                # move to front
                daemons.remove('sitech')
                daemons.insert(0, 'sitech')
            elif sys.argv[1] == 'shutdown':
                # move to back
                daemons.remove('sitech')
                daemons.append('sitech')

        for d in daemons:
            print(d+':\t', end='')
            time.sleep(1)
            misc.execute_command('{} {}'.format(d,sys.argv[1]))
    else:
        print('Valid commands: start, shutdown, kill, ping')
