#!/usr/bin/env python
"""
A script to provide control over the cam daemon
"""

import os
import sys
import time
import readline
import Pyro4

from gtecs import misc
from gtecs import errors
from gtecs import params
from gtecs import style
from gtecs import daemons


DAEMON_ID = os.path.basename(__file__)


def query(command, args, daemon_ID):
    # Command functions
    if command in ['help', '?']:
        print_instructions()

    elif command == 'i':
        raise errors.InputError('Already in interactive mode')

    # Primary daemon control
    elif command == 'start':
        reply = daemons.start_daemon(daemon_ID)
        print(reply)

    elif command == 'shutdown':
        reply = daemons.shutdown_daemon(daemon_ID)
        print(reply)

    elif command == 'restart':
        reply = daemons.restart_daemon(daemon_ID)
        print(reply)

    elif command == 'kill':
        reply = daemons.kill_daemon(daemon_ID)
        print(reply)

    elif command == 'ping':
        reply = daemons.ping_daemon(daemon_ID)
        print(reply)

    elif command in ['info', 'status']:
        # parse arguments
        if len(args) == 0:
            info_type = 'simple'
        elif len(args) == 1 and args[0] in ['v','V','-v','-V']:
            info_type = 'verbose'
        else:
            raise errors.InputError('Invalid arguments')
        # send command
        reply = daemons.daemon_function(daemon_ID, 'get_info')
        # print response
        if not reply:
            raise ValueError('No info returned, check daemon')
        elif info_type == 'simple':
            print_info_s(reply)
        elif info_type == 'verbose':
            print_info(reply)

    elif command in ['log', 'tail']:
        # parse arguments
        if 'stdout' in args:
            log_path = params.LOG_PATH + daemon_ID + '-stdout.log'
            args.remove('stdout')
        else:
            log_path = params.LOG_PATH + daemon_ID + '.log'
        tail_command = 'tail {} {}'.format(log_path, ' '.join(args))
        # send command
        misc.execute_long_command(tail_command)

    # Daemon functions
    elif command == 'image':
        # parse arguments
        if len(args) == 2 and misc.is_num(args[0]) and misc.is_num(args[1]):
            tel_list = sorted(params.TEL_DICT)
            exptime = float(args[0])
            binning = float(args[1])
            imgtype = 'SCIENCE'
        elif len(args) == 3 and misc.is_num(args[1]) and misc.is_num(args[2]):
            tel_list = misc.valid_ints(args[0].split(','),sorted(params.TEL_DICT))
            exptime = float(args[1])
            binning = float(args[2])
            imgtype = 'SCIENCE'
        else:
            raise errors.InputError('Invalid arguments')
        # send command
        arg_list = [exptime, binning, imgtype, tel_list]
        reply = daemons.daemon_function(daemon_ID, 'take_image', arg_list)
        print(reply)

    elif command == 'glance':
        # parse arguments
        if len(args) == 2 and misc.is_num(args[0]) and misc.is_num(args[1]):
            tel_list = sorted(params.TEL_DICT)
            exptime = float(args[0])
            binning = float(args[1])
            imgtype = 'SCIENCE'
        elif len(args) == 3 and misc.is_num(args[1]) and misc.is_num(args[2]):
            tel_list = misc.valid_ints(args[0].split(','),sorted(params.TEL_DICT))
            exptime = float(args[1])
            binning = float(args[2])
            imgtype = 'SCIENCE'
        else:
            raise errors.InputError('Invalid arguments')
        # send command
        arg_list = [exptime, binning, imgtype, tel_list]
        reply = daemons.daemon_function(daemon_ID, 'take_glance', arg_list)
        print(reply)

    elif command == 'dark':
        # parse arguments
        if len(args) == 2 and misc.is_num(args[0]) and misc.is_num(args[1]):
            tel_list = sorted(params.TEL_DICT)
            exptime = float(args[0])
            binning = float(args[1])
            imgtype = 'DARK'
        elif len(args) == 3 and misc.is_num(args[1]) and misc.is_num(args[2]):
            tel_list = misc.valid_ints(args[0].split(','),sorted(params.TEL_DICT))
            exptime = float(args[1])
            binning = float(args[2])
            imgtype = 'DARK'
        else:
            raise errors.InputError('Invalid arguments')
        # send command
        arg_list = [exptime, binning, imgtype, tel_list]
        reply = daemons.daemon_function(daemon_ID, 'take_dark', arg_list)
        print(reply)

    elif command == 'bias':
        # parse arguments
        if len(args) == 1:
            tel_list = sorted(params.TEL_DICT)
            exptime = 0.0
            binning = float(args[0])
            imgtype = 'BIAS'
        elif len(args) == 2:
            tel_list = misc.valid_ints(args[0].split(','),sorted(params.TEL_DICT))
            exptime = 0.0
            binning = float(args[1])
            imgtype = 'BIAS'
        else:
            raise errors.InputError('Invalid arguments')
        # send command
        arg_list = [exptime, binning, imgtype, tel_list]
        reply = daemons.daemon_function(daemon_ID, 'take_dark', arg_list)
        print(reply)

    elif command == 'abort':
        # parse arguments
        if len(args) == 0:
            tel_list = sorted(params.TEL_DICT)
        elif len(args) == 1:
            tel_list = misc.valid_ints(args[0].split(','),sorted(params.TEL_DICT))
        else:
            raise errors.InputError('Invalid arguments')
        # send command
        reply = daemons.daemon_function(daemon_ID, 'abort_exposure', [tel_list])
        print(reply)

    elif command == 'temp':
        # parse arguments
        if len(args) == 1 and misc.is_num(args[0]):
            tel_list = sorted(params.TEL_DICT)
            target_temp = float(args[0])
        elif len(args) == 2 and misc.is_num(args[1]):
            tel_list = misc.valid_ints(args[0].split(','),sorted(params.TEL_DICT))
            target_temp = float(args[1])
        else:
            raise errors.InputError('Invalid arguments')
        # send command
        reply = daemons.daemon_function(daemon_ID, 'set_temperature', [target_temp, tel_list])
        print(reply)

    # Unrecognized function
    else:
        raise errors.InputError('Unrecognized command "{}"'.format(command))


def print_info(info):
    print('####### CAMERA INFO #######')
    for tel in sorted(params.TEL_DICT):
        print('CAMERA ' + str(tel) + ' (%s-%i)'%tuple(params.TEL_DICT[tel]))
        if info['status'+str(tel)] != 'Exposing':
            print('Status: %s' %info['status'+str(tel)])
        else:
            if info['run_number'] > 0:
                print('Status: %s r%07d (%.2fs)' %(info['status'+str(tel)],info['run_number'],info['remaining'+str(tel)]))
            else:
                print('Status: %s glance (%.2fs)' %(info['status'+str(tel)],info['remaining'+str(tel)]))
            if info['current_exposure'] and tel in info['current_exposure'].tel_list:
                print('Exposure time:      %.2fs' %info['current_exposure'].exptime)
                print('Binning:            %i' %info['current_exposure'].binning)
                print('Frame type:         %s' %info['current_exposure'].frametype)
        print('CCD Temperature:    %.2fC' %info['ccd_temp'+str(tel)])
        print('Target Temperature: %.2fC' %info['target_temp'+str(tel)])
        print('Base Temperature:   %.2fC' %info['base_temp'+str(tel)])
        print('Cooler power:       %i%%' %info['cooler_power'+str(tel)])
        print('Serial number:      %s' %info['serial_number'+str(tel)])
        print('~~~~~~~')
    print('Uptime: %.1fs' %info['uptime'])
    print('Ping: %.5fs' %info['ping'])
    print('Timestamp: %s' %info['timestamp'])
    print('###########################')


def print_info_s(info):
    for tel in sorted(params.TEL_DICT):
        print('CAMERA ' + str(tel) + ' (%s-%i)'%tuple(params.TEL_DICT[tel]), end=' ')
        if info['status'+str(tel)] != 'Exposing':
            print('  Temp: %6.2fC' %info['ccd_temp'+str(tel)], end=' ')
            print('  [%s]' %info['status'+str(tel)])
        else:
            if info['run_number'] > 0:
                print('  %s r%07d (%.2fs)' %(info['status'+str(tel)],info['run_number'],info['remaining'+str(tel)]))
            else:
                print('  %s glance (%.2fs)' %(info['status'+str(tel)],info['remaining'+str(tel)]))


def print_instructions():
    help_str = style.bold('Usage:') + ' cam [command]' + '\n' +\
    ' ' + style.undl('Daemon commands') + ':' + '\n' +\
    '  cam ' + style.bold('start') + '                        - start the daemon' + '\n' +\
    '  cam ' + style.bold('shutdown') + '                     - shutdown the daemon' + '\n' +\
    '  cam ' + style.bold('restart') + '                      - restart the daemon' + '\n' +\
    '  cam ' + style.bold('kill') + '                         - kill the daemon (' + style.rtxt('emergency use') + ')' + '\n' +\
    '  cam ' + style.bold('ping') + '                         - ping the daemon' + '\n' +\
    ' ' + style.undl('Camera commands') + ':' + '\n' +\
    '  cam ' + style.bold('image') + ' [tels] exptime binning' + ' - take a normal exposure' + '\n' +\
    '  cam ' + style.bold('glance') + ' [tels] exptime binning' + ' - take a temporary glance' + '\n' +\
    '  cam ' + style.bold('dark') + ' [tels] exptime binning' + '  - take a dark frame' + '\n' +\
    '  cam ' + style.bold('bias') + ' [tels] binning' + '          - take a bias frame' + '\n' +\
    '  cam ' + style.bold('abort') + ' [tels]' + '                 - abort current exposure' + '\n' +\
    '  cam ' + style.bold('temp') + ' [tels] temp' + '             - set camera temperature' + '\n' +\
    '  cam ' + style.bold('info') + '/' + style.bold('status') + ' [v]' + '              - report current status' + '\n' +\
    '  cam ' + style.bold('log') + ' [stdout]' + '                 - print daemon log (tail alias)' + '\n' +\
    ' ' + style.undl('Control commands') + ':' + '\n' +\
    '  cam ' + style.bold('i') + '                            - enter interactive mode' + '\n' +\
    '  cam ' + style.bold('q') + '/' + style.bold('exit') + '                       - quit interactive mode' + '\n' +\
    '  cam ' + style.bold('?') + '/' + style.bold('help') + '                       - print these instructions'
    print(help_str)


if __name__ == "__main__":
    if len(sys.argv) == 1:
        print_instructions()
    else:
        command, *args = sys.argv[1:]
        if command == 'i':
            while True:
                interactive_input = input('{}> '.format(DAEMON_ID)).split()
                if len(interactive_input) > 0:
                    command, *args = interactive_input
                    if command in ['q', 'exit']:
                        break
                    else:
                        with misc.print_errors():
                            query(command, args, DAEMON_ID)
        else:
            with misc.print_errors():
                query(command, args, DAEMON_ID)
